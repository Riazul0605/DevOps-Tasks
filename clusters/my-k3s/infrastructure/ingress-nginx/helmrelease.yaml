apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ingress-nginx
  namespace: ingress-nginx
spec:
  interval: 5m
  chart:
    spec:
      chart: ingress-nginx
      version: 4.11.7
      sourceRef:
        kind: HelmRepository
        name: ingress-nginx
        namespace: flux-system
  install:
    createNamespace: true
  upgrade:
    remediation:
      retries: 3
  values:
   controller:
    service:
      type: LoadBalancer
    allowSnippetAnnotations: true
    config:
      # tell ingress-nginx to use Lua dynamic modules
      lua-shared-dicts: "cache:10m"
      proxy-intercept-404: "true"
    extraVolumes:
      - name: lua-redirect-404
        configMap:
          name: lua-redirect-404
      - name: lua-configuration
        configMap:
          name: lua-configuration
    extraVolumeMounts:
      - name: lua-redirect-404
        mountPath: /etc/nginx/lua/redirect
        readOnly: true
      - name: lua-configuration
        mountPath: /etc/nginx/lua/config
        readOnly: true
    # Inject Lua hook into nginx.conf
    server-snippet: |
      error_page 404 = @custom_404;
      location @custom_404 {
        return 302 https://www.google.com;
      }
